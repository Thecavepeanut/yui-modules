YUI.add("gallery-quickedit",function(b){function e(r){e.superclass.constructor.call(this,r);}e.NAME="QuickEditPlugin";e.NS="qe";e.ATTRS={changesAlwaysInclude:{value:[],validator:b.Lang.isArray}};var c="(?:^|\\s)(?:",j=")(?:\\s|$)",m=/quickedit-key:([^\s]+)/,k="quickedit-has",f=k+"([a-z]+)",i=new RegExp(c+f+j),o="quickedit-has",n=o+"([a-z]+)",l=new RegExp(c+n+j);e.error_text_class="quickedit-message-text";e.error_display_markup='<div class="quickedit-message-text"></div>';e.copy_down_button_class="quickedit-copy-down";e.textFormatter=function(t){var r='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+"{cd}"+e.error_display_markup;var s=t.column.quickEdit;return b.Lang.sub(r,{key:t.column.key,value:t.value.toString().replace(/"/g,"&quot;"),yiv:s.validation?(s.validation.css||""):"",cd:e.copyDownFormatter.call(this,t)});};e.textareaFormatter=function(t){var r='<textarea class="{yiv} quickedit-field quickedit-key:{key}">{value}</textarea>'+"{cd}"+e.error_display_markup;var s=t.column.quickEdit;return b.Lang.sub(r,{key:t.column.key,value:t.value,yiv:s.validation?(s.validation.css||""):"",cd:e.copyDownFormatter.call(this,t)});};e.readonlyEmailFormatter=function(r){return(r.value||"");};e.readonlyLinkFormatter=function(r){return(r.value||"");};function p(t,s){var v=null;this._tbodyNode.get("children").some(function(w){if(w.contains(t)){v=w;return true;}});if(!v){return null;}var r=t.getAncestorByTagName("td",true);var u=-1;v.get("children").some(function(x,w){if(x===r){u=w;return true;}});v=(s<0?v.previous():v.next());return v?v.get("children").item(u):null;}function g(u){var r=u.currentTarget.ancestor(".yui3-datatable-cell");var t=r.one(".quickedit-field");if(!t){return;}var s=b.Lang.trim(t.get("value"));if(!s&&s!==0){return;}while(1){r=p.call(this,r,+1);if(!r){break;}t=r.one(".quickedit-field");if(t){t.set("value",s);}}}e.copyDownFormatter=function(r,s){if(r.column.quickEdit.copyDown&&r.rowindex===0){return b.Lang.sub('<button title="Copy down" class="{c}">&darr;</button>',{c:e.copy_down_button_class});}else{return"";}};function d(s,r){return function(t){if(!t.record&&b.Lang.isString(r)){return r;}else{return(t.record?s:r).apply(this,arguments);}};}function q(t){var r=p.call(this,t.target,t.charCode==38?-1:+1);if(r){var s=r.one(".quickedit-field");if(s){s.focus();s.select();t.halt(true);}}}function a(){var t=this.get("host").get("columns");var s={};function r(w,v){if(b.Lang.isString(v)){var u={key:v};w.push(u);s[v]=u;}else{if(v.children){w=b.reduce(v.children,w,r);}else{w.push(v);s[v.key]=v;}}return w;}this.column_list=b.reduce(t,[],r);this.column_map=s;}function h(x){var z=this.get("host");var t=true;var v=x.size();for(var u=0;u<v;u++){var w=x.item(u);var s=this.column_map[this._getColumnKey(w)].quickEdit;if(!s){continue;}var y=s.validation?s.validation.msg:null;var r=b.FormManager.validateFromCSSData(w,y);if(r.error){this.displayMessage(w,r.error,"error");t=false;continue;}if(r.keepGoing){if(s.validation&&s.validation.regex instanceof RegExp&&!s.validation.regex.test(w.get("value"))){this.displayMessage(w,y?y.regex:null,"error");t=false;continue;}}if(s.validation&&b.Lang.isFunction(s.validation.fn)&&!s.validation.fn.call(z,w)){t=false;continue;}}return t;}b.extend(e,b.Plugin.Base,{initializer:function(r){var t=this.get("host");this.hasMessages=false;a.call(this);this.get("host").after("columnsChange",a,this);var s=this.afterHostEvent("render",function(){t.get("boundingBox").delegate("click",g,"."+e.copy_down_button_class,t);s.detach();});},start:function(){this.fire("clearErrorNotification");var x=this.get("host");this.saveSort=[];this.saveEdit=[];this.saveFmt={};for(var v=0;v<this.column_list.length;v++){var t=this.column_list[v];var u=t.key;this.saveSort.push(t.sortable);t.sortable=false;var s=t.quickEdit;var y=t.qeFormatter;if(
/*!col.hidden &&*/
(s||y)){var w=null;if(s&&b.Lang.isFunction(s.formatter)){w=s.formatter;}else{if(b.Lang.isFunction(y)){w=y;}else{w=e.textFormatter;}}if(w){this.saveFmt[u]={formatter:t.formatter,nodeFormatter:t.nodeFormatter,allowHTML:t.allowHTML};t.formatter=d.call(this,w,t.formatter||t.nodeFormatter);t.nodeFormatter=null;t.allowHTML=true;}}}var r=x.get("contentBox");r.addClass(x.getClassName("quickedit"));this.move_event_handle=r.on("key",q,"down:38+ctrl,40+ctrl",x);x.set("columns",x.get("columns"));},cancel:function(){this.fire("clearErrorNotification");for(var t=0;t<this.column_list.length;t++){var s=this.column_list[t];s.sortable=this.saveSort[t];}delete this.saveSort;delete this.saveEdit;b.each(this.saveFmt,function(v,x){var w=this.column_map[x];w.formatter=v.formatter;w.nodeFormatter=v.nodeFormatter;w.allowHTML=v.allowHTML;},this);delete this.saveFmt;var u=this.get("host");var r=u.get("contentBox");r.removeClass(u.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}u.set("columns",u.get("columns"));},getChanges:function(){if(!this.validate()){return false;}var s=[];var r=this.get("changesAlwaysInclude");var t=this.get("host");var u=t._tbodyNode.get("children");t.get("data").each(function(y,A){var B=u.item(A).all(".quickedit-field");var C={};s.push(C);var D=B.size();for(var z=0;z<D;z++){var E=B.item(z);var F=this._getColumnKey(E);var x=this.column_map[F].quickEdit;var w=y.get(F);var v=b.Lang.trim(E.get("value"));if(x.changed?x.changed(w,v):v!==(w?w.toString():"")){C[F]=v;}}for(var z=0;z<r.length;z++){var F=r[z];C[F]=y.get(F);}},this);return s;},validate:function(){this.clearMessages();var r=true;var s=this.get("host");var v=s._tbodyNode.getElementsByTagName("input");var u=s._tbodyNode.getElementsByTagName("textarea");var t=s._tbodyNode.getElementsByTagName("select");r=h.call(this,v)&&r;r=h.call(this,u)&&r;r=h.call(this,t)&&r;if(!r){this.fire("notifyErrors");}return r;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var r=this.get("host");r._tbodyNode.getElementsByClassName(f).removeClass(f);r._tbodyNode.getElementsByClassName(n).removeClass(n);
r._tbodyNode.all("."+e.error_text_class).set("innerHTML","");},displayMessage:function(u,w,t,s){if(b.Lang.isUndefined(s)){s=true;}u=b.one(u);var v=u.getAncestorByTagName("tr");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(v,i),t)){if(!this.hasMessages&&s){b.one(v.get("firstChild")).scrollIntoView();}v.replaceClass(f,k+t);this.hasMessages=true;}var r=u.getAncestorByTagName("td");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(r,l),t)){if(w){r.one("."+e.error_text_class).set("innerHTML",w);}r.replaceClass(n,o+t);this.hasMessages=true;}},_getElementStatus:function(u,t){var s=u.get("className").match(t);return((s&&s.length)?s[1]:false);},_getColumnKey:function(s){var r=m.exec(s.get("className"));return r[1];}});b.namespace("Plugin");b.Plugin.DataTableQuickEdit=e;},"@VERSION@",{optional:["gallery-scrollintoview"],skinnable:true,requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations","gallery-funcprog"]});