YUI.add("gallery-datatable-row-expansion",function(a){function b(k){b.superclass.constructor.call(this,k);}b.NAME="DataTableRowExpansionPlugin";b.NS="rowexpander";b.ATTRS={template:{value:"",validator:function(k){return(a.Lang.isString(k)||a.Lang.isFunction(k));}},uniqueIdKey:{value:"",validator:a.Lang.isString}};b.column_key="row-expander";b.row_class="row-expansion";function h(r){var p=this.rowexpander;var t="";for(var m=0;m<=p.col_count.pre;m++){t+='<td class="yui3-datatable-cell pre-row-expansion">&nbsp;</td>';}var l=p.get("template");if(a.Lang.isFunction(l)){var n=l.call(this,r.data);}else{var n=a.Lang.sub(l,r.data);}var q=r.cell.ancestor();var k=a.Lang.sub('<tr class="{c}">'+"{pre}"+'<td colspan="{post}" class="yui3-datatable-cell post-row-expansion">{tmpl}</td>'+"</tr>",{c:q.get("className")+" "+b.row_class,pre:t,post:p.col_count.post,tmpl:n});q.insert(k,"after");}function g(n){var m=this.rowexpander,l=n.data[m.get("uniqueIdKey")],k=m.open_rows[l];n.td.addClass("row-toggle");n.td.replaceClass("row-(open|closed)",k?"row-open":"row-closed");n.td.on("click",function(){var o=m.open_rows[l]=!m.open_rows[l];if(o){h.call(this,n);}else{n.cell.ancestor().next().remove();}},this);n.cell.set("innerHTML",'<a class="row-expand-nub" href="javascript:void(0);"></a>');if(k){h.call(this,n);}}function f(){function k(l,m){if(m.key==b.column_key){m.nodeFormatter=g;l.found=true;}else{if(m.children){l=a.reduce(m.children,l,k);}else{l[l.found?"post":"pre"]++;}}return l;}this.col_count=a.reduce(this.get("host").get("columns"),{pre:0,post:0,found:false},k);}var d={above:[-1,0],below:[1,0],next:[0,1],prev:[0,-1],previous:[0,-1]};function j(n,k){var m=this.tbodyNode,t,r;if(n&&m){if(a.Lang.isString(k)){if(d[k]){k=d[k];}else{throw Error("unknown shift in getCell: "+k);}}if(a.Lang.isArray(n)){t=m.get("children").item(0);r=t&&t.get("children").item(n[1]);if(k){k[0]+=n[0];}else{k=[n[0],0];}}else{if(n._node){r=n.ancestor("."+this.getClassName("cell"),true);if(r.ancestor("tr."+b.row_class)){throw Error("getCell cannot be called with an element from an expansion row");}}}if(r&&k){var s=m.get("firstChild.rowIndex");if(a.Lang.isArray(k)){t=r.ancestor();var q=Math.sign(k[0]);if(q!==0){var u=m.get("children");var p=t.get("rowIndex")-s;var o=Math.abs(k[0]);for(var l=0;l<o&&t;l++){p+=q;t=u.item(p);if(t&&t.hasClass(b.row_class)){p+=q;t=u.item(p);}}}p=r.get("cellIndex")+k[1];r=t&&t.get("children").item(p);}}}return(r||null);}function e(m){var k=this.tbodyNode,l=null;if(k){if(m){m=this._idMap[m.get?m.get("clientId"):m]||m;}l=a.one(a.Lang.isNumber(m)?this.getCell([m,0]).ancestor():"#"+m);}return l;}function i(){var l=this.get("host").view;if(l instanceof a.DataTable.TableView&&l.body instanceof a.DataTable.BodyView){var k=l.body;this.orig_getCell=k.getCell;this.orig_getRow=k.getRow;k.getCell=j;k.getRow=e;}}function c(){var k=this.get("host").view;if(k.body&&this.orig_getCell){k.body.getCell=this.orig_getCell;}if(k.body&&this.orig_getRow){k.body.getRow=this.orig_getRow;}}a.extend(b,a.Plugin.Base,{initializer:function(k){this.open_rows={};this.on("uniqueIdKeyChange",function(){this.open_rows={};});f.call(this);this.afterHostEvent("columnsChange",f);this.afterHostEvent("table:renderTable",i);},destructor:function(){c.call(this);}});a.namespace("Plugin");a.Plugin.DataTableRowExpansion=b;},"@VERSION@",{requires:["datatable","plugin","gallery-funcprog","gallery-node-optimizations","gallery-math"],skinnable:true});