YUI.add("gallery-datatable-selection",function(e,t){function n(){}n.ATTRS={highlighted:{value:null,validator:function(t){return t instanceof e.Node||t===null}},selected:{value:null,validator:function(t){return t instanceof e.Node||t===null}},highlightMode:{value:"none",setter:"_setHighlightMode",validator:function(t){return e.Lang.isString(t)?t==="none"||t==="cell"||t==="row"?!0:!1:!1}},selectionMode:{value:"none",setter:"_setSelectionMode",validator:function(t){return e.Lang.isString(t)?t==="none"||t==="cell"||t==="row"?!0:!1:!1}},selectedRows:{value:[],validator:e.Lang.isArray,getter:"_getSelectedRows",setter:"_setSelectedRows"},selectedCells:{value:[],validator:e.Lang.isArray,setter:"_setSelectedCells",getter:"_getSelectedCells"},selectionMulti:{value:!1,setter:"_setSelectionMulti",validator:e.Lang.isBoolean}},e.mix(n.prototype,{_selections:null,_classHighlight:null,_classSelected:null,_clickModifiers:null,initializer:function(){this._bindSelector()},destructor:function(){this._unbindSelector()},enableSelection:function(){this.disableSelection(),this._bindSelector()},disableSelection:function(){this.clearAll(),this._unbindSelector()},getColumnByTd:function(e){var t=this.getColumnNameByTd(e);return t?this.getColumn(t):null},getColumnNameByTd:function(t){var n=t.get("className").split(" "),r=new RegExp(this.getClassName("col")+"-(.*)"),i;return e.Array.some(n,function(t){var n=t.match(r);if(n&&e.Lang.isArray(n)&&n[1])return i=n[1],!0}),i||null},getSelectedTds:function(){var t=[];return e.Array.each(this._selections,function(e){if(e.get("tagName").toLowerCase()==="td")t.push(e);else if(e.get("tagName").toLowerCase()==="tr"){var n=e.all("td");n&&n.each(function(e){t.push(e)})}}),t},clearSelections:function(){this._selections=[],this.set("selected",null),this._clearAll(this._classSelected)},clearHighlighted:function(){this.set("highlighted",null),this._clearAll(this._classHighlight)},clearAll:function(){this.clearSelections(),this.clearHighlighted()},_unbindSelector:function(){e.Array.each(this._eventHandles.selector,function(e){e.detach()}),this._eventHandles.selector=null,this._eventHandles.selectorSelect&&this._eventHandles.selectorSelect.detach(),this._eventHandles.selectorSelect=null,this._clickModifiers=null},_bindSelector:function(){this._selections=[],this._eventHandles.selector=[],this._eventHandles.selector.push(this.on("highlightedChange",this._highlightChange)),this._eventHandles.selector.push(this.on("selectedChange",this._selectedChange)),this._classHighlight=this.getClassName("sel","highlighted"),this._classSelected=this.getClassName("sel","selected"),this._eventHandles.selector.push(this.data.before("*:reset",e.bind("_beforeResetDataSelect",this))),this._eventHandles.selector.push(this.data.after("*:reset",e.bind("_afterResetDataSelect",this))),this._clickModifiers={ctrlKey:null,altKey:null,metaKey:null,shiftKey:null,which:null,button:null}},_highlightChange:function(e){var t=this._processNodeAction(e,"highlight",!0)},_selectedChange:function(t){var n,r;e.UA.os.search("macintosh")===0?n=this.get("selectionMulti")===!0&&this._clickModifiers.metaKey===!0:n=this.get("selectionMulti")===!0&&this._clickModifiers.ctrlKey===!0,r=this.get("selectionMulti")===!0&&this._clickModifiers.shiftKey===!0,this._clearDOMSelection(),!n&&!r&&this._selections.length>1&&this.clearSelections();if(r)this._processRange(t);else{var i=this._processNodeAction(t,"select",!n);n||(this._selections=[]),this._selections.push(i)}this.fire("selected",{ochange:t,record:this.getRecord(t.newVal)});var s={selectionMode:this.get("selectionMode")};this.get("selectionMode").toLowerCase()==="cell"?s.cells=this.get("selectedCells"):this.get("selectionMode").toLowerCase()==="row"&&(s.rows=this.get("selectedRows")),this.fire("selection",s)},_processRange:function(t){var n=t.newVal,r=t.prevVal||null;if(n&&r){var i=this.getRecord(n),s=this.data.indexOf(i),o=this.getColumnNameByTd(n),u=e.Array.indexOf(this.get("columns"),this.getColumn(o)),a=this.getRecord(r),f=this.data.indexOf(a),l=this.getColumnNameByTd(r),c=e.Array.indexOf(this.get("columns"),this.getColumn(l)),h=u-c,p=s-f;if(h!==null&&p!==null){e.Lang.isArray(this._selections)&&this.clearSelections();if(this.get("selectionMode")==="cell"){var d=h<0?-1:1,v=p<0?-1:1,m=r;for(var g=0;g<=Math.abs(p);g++)for(var y=0;y<=Math.abs(h);y++)m=this.getCell(r,[v*g,d*y]),m&&(m.addClass(this._classSelected),this._selections.push(m))}else if(this.get("selectionMode")==="row"){var v=p<0?-1:1,b=this.getRow(f);for(var g=0;g<=Math.abs(p);g++)b=this.getRow(f+v*g),b&&(b.addClass(this._classSelected),this._selections.push(b))}}}},_getSelectedRows:function(){var t=[],n=[],r,i;return e.Array.each(this._selections,function(s){r=s.get("tagName").toLowerCase()==="tr"?s:s.ancestor("tr"),r.get("tagName").toLowerCase()==="tr"&&e.Array.indexOf(t,r)===-1&&(i=this.data.getByClientId(r.getData("yui3-record")),t.push(r),n.push({tr:r,record:i,recordIndex:this.data.indexOf(i)}))},this),n},_getSelectedCells:function(){var t=[],n=this.get("columns"),r,i,s;return e.Array.each(this._selections,function(o){if(!o)return;if(o.get("tagName").toLowerCase()==="td")r=this.getColumnByTd(o),i=o.ancestor("tr"),s=this.data.getByClientId(i.getData("yui3-record")),t.push({td:o,record:s,recordIndex:this.data.indexOf(s),column:r,columnName:r.key||r.name,columnIndex:e.Array.indexOf(n,r)});else if(o.get("tagName").toLowerCase()==="tr"){i=o,s=this.data.getByClientId(i.getData("yui3-record"));var u=i.all("td");u&&u.each(function(i){r=this.getColumnByTd(i),t.push({td:i,record:s,recordIndex:this.data.indexOf(s),column:r,columnName:r.key||r.name,columnIndex:e.Array.indexOf(n,r)})},this)}},this),t},_setSelectedCells:function(t){return this._selections=[],e.Lang.isArray(t)&&this.data.size()>t.length&&e.Array.each(t,function(e){var t,n,r;e.record&&(t=this.getRow(e.record)),e.column&&(n=this.getColumn(e.column));if(t&&n){var i=n.key||n.name;i&&(r=t.one("."+this.getClassName("col")+"-"+i),this._selections.push(r),r.addClass(this._classSelected))}},this),t},_setSelectedRows:function(t){return this._selections=[],e.Lang.isArray(t)&&this.data.size()>t.length&&e.Array.each(t,function(e){var t=this.getRow(e);t&&(this._selections.push(t),t.addClass(this._classSelected))},this),t},_beforeResetDataSelect:function(){if(!this._selections||this._selections.length===0)return;var t=this.get("selectedRows"),n=this.get("selectedCells"),r,i;this._selections=[],this.set("selected",null),this._clearAll(this._classSelected),this.get("selectionMode")==="row"&&t&&t.length>0?e.Array.each(t,function(e){e&&e.record&&this._selections.push(e.record)},this):this.get("selectionMode")==="cell"&&n&&n.length>0&&e.Array.each(n,function(e){e&&e.record&&e.columnIndex&&this._selections.push({record:e.record,colIndex:e.columnIndex})},this)},_afterResetDataSelect:function(){if(!this._selections||this._selections.length===0)return;var t,n,r=[];e.Array.each(this._selections,function(e){this.get("selectionMode")==="row"&&e?(t=this.getRow(e),t&&(r.push(t),t.addClass(this._classSelected))):this.get("selectionMode")==="cell"&&e&&(t=this.getRow(e.record),n=t?t.all("td").item(e.colIndex):null,t&&n&&(r.push(n),n.addClass(this._classSelected)))},this),this._selections=r},_processNodeAction:function(e,t,n){var r=e.newVal,i,s,o,u;return t==="highlight"?(o=t+"Mode",u=this._classHighlight):t==="select"&&(o="selectionMode",u=this._classSelected),this.get(o)=="cell"?(i=r||null,s=e.prevVal||null):this.get(o)=="row"&&(r&&(i=r.get("tagName").search(/td/i)===0?r.ancestor("tr"):r.get("tagName").search(/tr/i)===0?r:null),s=e.prevVal,s&&(s=s.get("tagName").search(/td/i)===0?s.ancestor("tr"):s.get("tagName").search(/tr/i)===0?s:null)),s&&n&&s.removeClass(u),i&&i.addClass(u),i},_clearAll:function(e){var t=this.get("boundingBox").one("."+this.getClassName("data"));t&&t.all("."+e).removeClass(e)},_setHighlightMode:function(e){this._eventHandles.selectorHighlight&&this._eventHandles.selectorHighlight.detach();if(e==="none")return;return this._eventHandles.selectorHighlight=this.delegate("mouseover",function(e){var t=e.currentTarget;this.set("highlighted",t)},"tr td",this),this._clearAll(this._classHighlight),e},_setSelectionMode:function(e){var t=this;this._eventHandles.selectorSelect&&this._eventHandles.selectorSelect.detach();if(e==="none")return;return this._eventHandles.selectorSelect=this.delegate("click",function(e){var n=e.currentTarget;t._clickModifiers={ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,shiftKey:e.shiftKey,which:e.which,button:e.button},t.set("selected",n)},"tr td",t),this._clearAll(this._classSelected),e},_clearDOMSelection:function(){var t=e.config.win.getSelection?e.config.win.getSelection():e.config.doc.selection?e.config.doc.selection:null;t&&t.empty&&t.empty(),t&&t.removeAllRanges&&t.removeAllRanges()}}),e.DataTable.Selection=n,e.Base.mix(e.DataTable,[e.DataTable.Selection])},"gallery-2012.12.05-21-01",{skinnable:"true",requires:["base-build","datatable-base","event"]});
