YUI.add("gallery-querybuilder",function(A){var D=(0<A.UA.ie&&A.UA.ie<9);function B(K,J,L){if(arguments.length===0){return;}if(!A.FormManager){A.FormManager={row_marker_class:"",status_marker_class:"",required_class:""};}this.var_list=K.slice(0);this.op_list=A.clone(J,true);this.op_list.none=[];this.row_list=[];B.superclass.constructor.call(this,L);}B.NAME="querybuilder";B.ATTRS={chooseVarPrompt:{value:"Choose a Variable",validator:A.Lang.isString,writeOnce:true},fieldPrefix:{value:"",validator:A.Lang.isString,writeOnce:true},pluginConfig:{value:{},validator:A.Lang.isObject,writeOnce:true}};function F(){this.var_list.unshift({name:"yui3-querybuilder-choose-prompt",type:"none",text:this.get("chooseVarPrompt")});}function I(L,M){var K=L.length;for(var J=0;J<K;J++){if(L[J].row==M){return J;}}return -1;}function H(K,J){this.appendNew();}function G(L,K){var J=I(this.row_list,K);if(J>=0){this.remove(J);}}function C(L,K){var J=I(this.row_list,K);if(J>=0){this.update(J);}}function E(J){if(J.keyCode!=13){this._notifyChanged();}}A.extend(B,A.Widget,{initializer:function(J){var K=this.get("fieldPrefix");this.var_menu_name_pattern=K+"query_var_{i}";this.get("pluginConfig").fieldPrefix=K;this.plugin_column_count=0;F.call(this);},renderUI:function(){var J=this.get("contentBox");J.on("change",this._notifyChanged,this);J.on("keyup",E,this);this.table=A.Node.create("<table></table>");J.appendChild(this.table);this.appendNew();},destructor:function(){for(var J=0;J<this.row_list.length;J++){if(this.row_list[J].plugin){this.row_list[J].plugin.destroy();}}this.row_list=null;this.table=null;},reset:function(K,J){this._allow_remove_last_row=true;for(var L=this.row_list.length-1;L>=0;L--){this.remove(L);}this._allow_remove_last_row=false;if(K){this.var_list=K.slice(0);F.call(this);}if(J){this.op_list=A.clone(J,true);this.op_list.none=[];}this.appendNew();},appendNew:function(M,W){if(M&&this.row_list.length==1){var O=this.row_list[0].var_menu;if(O.get("selectedIndex")===0){for(var R=0;R<this.var_list.length;R++){if(this.var_list[R].name==M){O.set("selectedIndex",R);break;}}this.update(0,W);return this.row_list[0].plugin;}}var U=this.row_list.length;var K=A.Node.create("<tbody></tbody>");K.set("className",A.FormManager.row_marker_class);var T=A.Node.create("<tr></tr>");T.set("className",this.getClassName("error"));K.appendChild(T);var L=this._createContainer();L.set("colSpan",1+this.plugin_column_count);L.set("innerHTML",'<p class="'+A.FormManager.status_marker_class+'"></p>');T.appendChild(L);T.appendChild(this._createContainer());var Q=A.Node.create("<tr></tr>");Q.set("className",this.getClassName("criterion"));K.appendChild(Q);var J=this._createContainer();J.set("className",this.getClassName("variable"));Q.appendChild(J);J.set("innerHTML",this._variablesMenu(this.variableName(U)));var O=J.one("select");O.on("change",C,this,Q);var X=A.Node.getDOMNode(O).options;for(var R=0;R<this.var_list.length;R++){X[R]=new Option(this.var_list[R].text,this.var_list[R].name);if(this.var_list[R].name==M){O.set("selectedIndex",R);}}if(D){O.on("change",this._notifyChanged,this);}var S=this._createContainer();S.set("className",this.getClassName("controls"));S.set("innerHTML",this._rowControls());Q.appendChild(S);var N=S.one("."+this.getClassName("insert"));if(N){N.on("click",H,this,Q);}var V=S.one("."+this.getClassName("remove"));if(V){V.on("click",G,this,Q);}this.table.appendChild(K);var P={body:K,row:Q,var_menu:O,control:S,error:L};this.row_list.push(P);this.update(U,W);K.scrollIntoView();return this.row_list[U].plugin;},update:function(T,U){var Q=this.row_list[T].row;var S=this.row_list[T].control;this.row_list[T].error.one("."+A.FormManager.status_marker_class).set("innerHTML","");if(this.row_list[T].plugin){this.row_list[T].plugin.destroy();this.row_list[T].plugin=null;}while(Q.get("children").size()>2){var L=Q.get("children").item(0).next();L.remove(true);}var M=this.row_list[T].var_menu;var K=this.var_list[M.get("selectedIndex")];var V=[];if(K.type!="none"){this.row_list[T].plugin=new B.plugin_mapping[K.type](this,this.get("pluginConfig"));V=this.row_list[T].plugin.create(T,K,this.op_list[K.type],U);}while(V.length<this.plugin_column_count){V.push(this._createContainer());}for(var P=0;P<V.length;P++){Q.insertBefore(V[P],S);}if(V.length>this.plugin_column_count){var J=1+V.length;for(var P=0;P<this.row_list.length;P++){var W=this.row_list[P].row;this.row_list[P].error.set("colSpan",J);if(W!=Q){var O=this.row_list[P].control;for(var N=this.plugin_column_count;N<V.length;N++){W.insertBefore(this._createContainer(),O);}}}this.plugin_column_count=V.length;}var R=this.row_list[T].plugin;if(R&&A.Lang.isFunction(R.postCreate)){this.row_list[T].plugin.postCreate(T,K,this.op_list[K.type],U);}},remove:function(L){if(this.row_list.length<=0){return false;}if(!this._allow_remove_last_row&&this.row_list.length==1){var K=this.row_list[0].var_menu;K.set("selectedIndex",0);this.update(0);this.fire("queryChanged",{remove:true});return true;}var N=this.row_list[L].body;if(N===null){return false;}if(this.row_list[L].plugin){this.row_list[L].plugin.destroy();}N.remove(true);this.row_list.splice(L,1);for(var J=0;J<this.row_list.length;J++){var K=this.row_list[J].var_menu;K.setAttribute("name",this.variableName(J));var M=this.var_list[K.get("selectedIndex")];if(M.type!="none"){this.row_list[J].plugin.updateName(J);}}this.fire("queryChanged",{remove:true});return true;},getPlugin:function(J){return this.row_list[J].plugin;},toDatabaseQuery:function(){var J=[];for(var L=0;L<this.row_list.length;L++){var O=this.row_list[L];var M=O.plugin;if(M){var N=M.toDatabaseQuery();for(var K=0;K<N.length;K++){J.push([O.var_menu.get("value")].concat(N[K]));}}}return J;},_createContainer:function(){return A.Node.create("<td></td>");},_notifyChanged:function(){this.fire("queryChanged");},variableName:function(J){return A.Lang.substitute(this.var_menu_name_pattern,{i:J});},_variablesMenu:function(K){var J='<select name="{n}" class="formmgr-field {c}" />';return A.Lang.substitute(J,{n:K,c:this.getClassName("field")});
},_rowControls:function(){var J='<span class="{ci}"></span>'+'<span class="{cr}"></span>';if(!this._controls_markup){this._controls_markup=A.Lang.substitute(J,{ci:this.getClassName("insert"),cr:this.getClassName("remove")});}return this._controls_markup;}});A.QueryBuilder=B;B.String=function(K,J){this.qb=K;this.op_menu_name_pattern=J.field_prefix+"query_op_{i}";this.val_input_name_pattern=J.field_prefix+"query_val_{i}";};B.String.prototype={create:function(O,N,J,P){var M=this.qb._createContainer();M.set("className",this.qb.getClassName("operator"));M.set("innerHTML",this._operationsMenu(this.operationName(O)));this.op_menu=M.one("select");var K=A.Node.getDOMNode(this.op_menu).options;for(var L=0;L<J.length;L++){K[L]=new Option(J[L].text,J[L].value);}P=P||["",""];if(P[0]){this.op_menu.set("value",P[0]);}if(D){this.op_menu.on("change",this.qb._notifyChanged,this.qb);}var Q=this.qb._createContainer();Q.set("className",this.qb.getClassName("value"));Q.set("innerHTML",this._valueInput(this.valueName(O),N.validation));this.value_input=Q.one("input");this.value_input.set("value",P[1]);return[M,Q];},postCreate:function(L,K,J,M){A.Lang.later(1,this,function(){if(this.value_input){this.value_input.focus();}});},destroy:function(){this.op_menu=null;this.value_input=null;},updateName:function(J){this.op_menu.setAttribute("name",this.operationName(J));this.value_input.setAttribute("name",this.valueName(J));},set:function(J,K){this.op_menu.set("value",K[this.operationName(J)]);this.value_input.set("value",K[this.valueName(J)]);},toDatabaseQuery:function(){return[[this.op_menu.get("value"),this.value_input.get("value")]];},operationName:function(J){return A.Lang.substitute(this.op_menu_name_pattern,{i:J});},valueName:function(J){return A.Lang.substitute(this.val_input_name_pattern,{i:J});},_operationsMenu:function(K){var J='<select name="{n}" class="formmgr-field {c}" />';return A.Lang.substitute(J,{n:K,c:this.qb.getClassName("field")});},_valueInput:function(L,K){var J='<input type="text" name="{n}" class="yiv-required formmgr-field {c}"/>';return A.Lang.substitute(J,{n:L,c:K+" "+this.qb.getClassName("field")});}};B.Select=function(K,J){this.qb=K;this.val_input_name_pattern=J.field_prefix+"query_val_{i}";};B.Select.prototype={create:function(O,N,J,P){var Q=this.qb._createContainer();Q.set("className",this.qb.getClassName("value"));Q.set("innerHTML",this._valuesMenu(this.valueName(O)));this.value_menu=Q.one("select");var K=A.Node.getDOMNode(this.value_menu).options;var M=N.value_list;for(var L=0;L<M.length;L++){K[L]=new Option(M[L].text,M[L].value);}if(P){this.value_menu.set("value",P);}if(D){this.value_menu.on("change",this.qb._notifyChanged,this.qb);}this.db_query_equals=J[0];return[Q];},postCreate:function(L,K,J,M){this.value_menu.focus();},destroy:function(){this.value_menu=null;},updateName:function(J){this.value_menu.setAttribute("name",this.valueName(J));},set:function(J,K){this.value_menu.set("value",K[this.valueName(J)]);},toDatabaseQuery:function(){return[[this.db_query_equals,this.value_menu.get("value")]];},valueName:function(J){return A.Lang.substitute(this.val_input_name_pattern,{i:J});},_valuesMenu:function(K){var J='<select name="{n}" class="formmgr-field {c}" />';return A.Lang.substitute(J,{n:K,c:this.qb.getClassName("field")});}};B.plugin_mapping={string:B.String,number:B.String,select:B.Select};},"@VERSION@",{requires:["widget","substitute"],optional:["gallery-formmgr","gallery-scrollintoview"],skinnable:true});