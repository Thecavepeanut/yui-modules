YUI.add("gallery-datetime",function(e,t){"use strict";function s(e){s.superclass.constructor.apply(this,arguments)}function o(t){return e.one(t)||Attribute.INVALID_VALUE}function u(){this.ignore_value_set||a.call(this,"same-day")}function a(t){var n=this.getDateTime();if(!n)return;n=n.date;var r=new Date(n.getTime()),i=this.get("blackouts");if(i.length>0){var s=n.getTime(),o=s,u=t=="same-day"?0:this.get("blackoutSnapDirection");for(var a=0;a<i.length;a++){var l=i[a];if(l[0]<s&&s<l[1]){u>0?s=l[1]+6e4:u<0?s=l[0]:s-l[0]<l[1]-s?s=l[0]:s=l[1]+6e4;break}}s!=o&&(n=new Date(s))}var c=this.get("minDateTime");if(c){var s=c.date.getTime();if(i.length>0){var o=s,a=0;while(a<i.length&&i[a][0]<s)s=Math.max(o,i[a][1]),a++}n.getTime()<s&&(n=new Date(s))}var h=this.get("maxDateTime");if(h){var s=h.date.getTime();if(i.length>0){var o=s,a=i.length-1;while(a>=0&&s<i[a][1])s=Math.min(o,i[a][0]),a--}s<n.getTime()&&(n=new Date(s))}if(n.getFullYear()!==r.getFullYear()||n.getMonth()!==r.getMonth()||n.getDate()!==r.getDate()){var p=f.call(this);p.dateInput=e.DateTimeUtils.formatDate(n),p.timeInput=e.DateTimeUtils.formatTime(n)}else if(n.getHours()!==r.getHours()||n.getMinutes()!==r.getMinutes()){var p=f.call(this);p.timeInput=e.DateTimeUtils.formatTime(n)}}function f(){return this.enforce_timer||(this.enforce_timer=e.later(0,this,function(){var t=this.enforce_timer;this.enforce_timer=null;var n=[];this.ignore_value_set=!0,e.each(["dateInput","timeInput"],function(e){t[e]&&(this.get(e).set("value",t[e]),n.push(e))},this),this.ignore_value_set=!1,h.apply(this,n),this.fire("limitsEnforced")})),this.enforce_timer}function l(){function t(){var t=u;e.each(arguments,function(e){t[e]||(t[e]={}),t=t[e]})}function i(e,n){var r=e.getFullYear(),i=e.getMonth(),s=e.getDate();t(r,i,s),u[r][i][s]=n}function s(e,t){var n=new Date(e);n.setDate(n.getDate()+t);while(n.getMonth()==e.getMonth())i(n,"disabled"),n.setDate(n.getDate()+t)}if(!this.calendar)return;var o=this.get("blackouts").slice(0),u={},a=this.get("minDateTime");if(a){if(o.length>0){var f=a.date.getTime(),l=!1;for(var h=0;h<o.length;h++){var p=o[h];if(p[1]<=f)o.shift(),h--;else if(p[0]<f){var d=new Date(p[0]);d.setHours(0),d.setMinutes(0),d.setSeconds(n),o[h]=[d.getTime(),p[1]],l=!0;break}}}!l&&(a.hour>0||a.minute>0)&&i(a.date,"partial"),s(a.date,-1)}var v=this.get("maxDateTime");if(v){if(o.length>0){var f=v.date.getTime(),l=!1;for(var h=o.length-1;h>=0;h--){var p=o[h];if(f<=p[0])o.pop();else if(f<p[1]){var m=new Date(p[1]);m.setHours(23),m.setMinutes(59),m.setSeconds(r),o[h]=[p[0],m.getTime()],l=!0;break}}}!l&&(v.hour<23||v.minute<59)&&i(v.date,"partial"),s(v.date,1)}for(var h=0;h<o.length;h++){var p=o[h],d=new Date(p[0]+r*1e3),m=new Date(p[1]+n*1e3);if(d.getHours()>0||d.getMinutes()>0)i(d,"partial"),d.setDate(d.getDate()+1),d.setHours(0);if(m.getHours()<23||m.getMinutes()<59)i(m,"partial"),m.setDate(m.getDate()-1),m.setHours(23);while(d.getTime()<m.getTime())i(d,"disabled"),d.setDate(d.getDate()+1)}this.calendar.set("customRenderer",{rules:u,filterFunction:c})}function c(t,n,r){e.Array.indexOf(r,"partial")>=0?n.addClass("yui3-datetime-partial"):e.Array.indexOf(r,"disabled")>=0&&n.addClass("yui3-calendar-selection-disabled")}function h(){var t=this.get("pingDuration");if(t<=0)return;var n=new e.NodeList(e.reduce(arguments,[],function(e,t){return e.push(this.get(t)),e},this)),r=this.get("pingClass");this.ping_task&&(this.ping_task.nodes.removeClass(r),this.ping_task.cancel(),n=n.concat(this.ping_task.nodes)),n.addClass(r),this.ping_task=e.later(t,this,function(){this.ping_task=null,n.removeClass(r)}),this.ping_task.nodes=n}var n=-40,r=40,i=0<e.UA.ie;s.NAME="datetime",s.ATTRS={dateInput:{setter:o,writeOnce:!0},timeInput:{setter:o,writeOnce:!0},defaultDateTime:{setter:function(t){return t?e.DateTimeUtils.normalize(t,this.get("blankTime")):null}},minDateTime:{setter:function(t){return t?e.DateTimeUtils.normalize(t,this.get("blankTime")):null}},maxDateTime:{setter:function(t){return t?e.DateTimeUtils.normalize(t,this.get("blankTime")):null}},blankTime:{value:{hour:0,minute:0},validator:function(t){return e.Lang.isObject(t)&&e.Lang.isNumber(t.hour)&&e.Lang.isNumber(t.minute)}},blackouts:{value:[],validator:e.Lang.isArray,setter:function(t){t=t||[];var i=[],s=this.get("blankTime");for(var o=0;o<t.length;o++){var u=t[o];u.start=e.DateTimeUtils.normalize(u.start,s),u.end=e.DateTimeUtils.normalize(u.end,s),u=[(new Date(u.start.year,u.start.month-1,u.start.day,u.start.hour,u.start.minute,n)).getTime(),(new Date(u.end.year,u.end.month-1,u.end.day,u.end.hour,u.end.minute,r)).getTime()];var a=!1;for(var f=0;f<i.length;f++){var l=i[f];if(u[0]<=l[0]){f>0&&u[0]<i[f-1][1]&&u[1]<=i[f-1][1]||(f>0&&u[0]-6e4<i[f-1][1]&&l[0]<u[1]+6e4?(u=[i[f-1][0],u[1]],i.splice(f-1,2,u)):f>0&&u[0]-6e4<i[f-1][1]?i[f-1][1]=u[1]:l[0]<u[1]+6e4?l[0]=u[0]:i.splice(f,0,u)),a=!0;break}}!a&&f>0&&u[0]<i[f-1][1]&&u[1]<=i[f-1][1]||(!a&&f>0&&u[0]-6e4<i[f-1][1]?i[f-1][1]=u[1]:a||i.push(u))}return i}},blackoutSnapDirection:{value:0,validator:function(e){return e==-1||e===0||e==+1}},pingDuration:{value:2e3,validator:e.Lang.isNumber},pingClass:{value:"yui3-datetime-ping",validator:e.Lang.isString}},e.extend(s,e.Base,{initializer:function(t,n){var r=this.get("dateInput");r.on("change",a,this),r.after("valueSet",u,this);var i=this.get("timeInput");if(i)i.on("change",a,this),i.after("valueSet",u,this);else{i=e.Node.create('<input type="hidden"></input>'),this.set("timeInput",i),i.set("value",e.DateTimeUtils.formatTime(this.get("blankTime")));var s=!0}var o=this.get("defaultDateTime");o&&(r.set("value",e.DateTimeUtils.formatDate(o)),s||i.set("value",e.DateTimeUtils.formatTime(o)));if(r.calendarSync){this.calendar=r.calendarSync.get("calendar"),this.calendar&&o&&this.calendar.set("date",o.date);var f=this.get("minDateTime");this.calendar&&f&&this.calendar.set("minimumDate",f.date),f=this.get("maxDateTime"),this.calendar&&f&&this.calendar.set("maximumDate",f.date)}l.call(this),this.on("blackoutsChange",l)},destroy:function(){},getDateTime:function(){try{var t=e.DateTimeUtils.parseDate(this.get("dateInput").get("value"));if(!t)return!1}catch(n){return!1}try{var r=e.DateTimeUtils.parseTime(this.get("timeInput").get("value"));if(!r)return!1}catch(n){return!1}var i=e.DateTimeUtils.normalize(e.mix(t,r));return i.date_str=e.DateTimeUtils.formatDate(i),i.time_str=e.DateTimeUtils.formatTime(i),i},setDateTime:function(e){this.rb[this.rb.length-1].checked=!0,this.calendar.setDate(e);if(e instanceof Date)this.hour_menu.value=e.getHours(),this.minute_menu.value=e.getMinutes();else if(e.time_str){var t=s.parseTime(e.time_str);this.hour_menu.value=t.hour,this.minute_menu.value=t.minute}else this.hour_menu.value=e.hour,this.minute_menu.value=e.minute;a.call(this)},resetDateTime:function(){this.default_date_time?(this.calendar.setDate(this.default_date_time),this.hour_menu.value=this.default_date_time.hour,this.minute_menu.value=this.default_date_time.minute):(this.calendar.clearDate(),this.hour_menu.value=this.blank_time.hour,this.minute_menu.value=this.blank_time.minute),a.call(this)},clearDateTime:function(){this.get("dateInput").set("value","");var e=this.get("timeInput");e&&e.set("value","")},setMinDateTime:function(t){if(t){t=e.DateTimeUtils.normalize(t,this.blank_time);if(!this.min_date_time||this.min_date_time.date.getTime()!=t.date.getTime())this.min_date_time=t,a.call(this),this.calendar.setMinDate(this.min_date_time),l.call(this)}else this.min_date_time&&(this.min_date_time=null,this.calendar.clearMinDate(),l.call(this))},setMaxDateTime:function(t){if(t){t=e.DateTimeUtils.normalize(t,this.blank_time);if(!this.max_date_time||this.max_date_time.date.getTime()!=t.date.getTime())this.max_date_time=t,a.call(this),this.calendar.setMaxDate(this.max_date_time),l.call(this)}else this.max_date_time&&(this.max_date_time=null,this.calendar.clearMaxDate(),l.call(this))}}),e.DateTime=s},"@VERSION@",{skinnable:"true",requires:["base","gallery-datetime-utils","gallery-funcprog"],optional:["calendar","gallery-timepicker"]});
