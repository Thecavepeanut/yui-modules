YUI.add("gallery-datatable-row-expansion",function(h){function f(i){f.superclass.constructor.call(this,i);}f.NAME="DataTableRowExpansionPlugin";f.NS="rowexpander";f.ATTRS={template:{value:"",validator:function(i){return(h.Lang.isString(i)||h.Lang.isFunction(i));}},uniqueIdKey:{value:"",validator:h.Lang.isString}};f.column_key="row-expander";f.row_class="row-expansion";function a(k){var n=this.rowexpander;var j=k.data[n.get("uniqueIdKey")];var m=n.open_rows[j];k.td.addClass("row-toggle");k.td.replaceClass("row-(open|closed)",m?"row-open":"row-closed");k.td.on("click",function(){n.open_rows[j]=!n.open_rows[j];h.later(0,this,function(){this.syncUI();});},this);k.cell.set("innerHTML",'<a class="row-expand-nub" href="javascript:void(0);"></a>');if(m){var r="";for(var l=0;l<=n.col_count.pre;l++){r+='<td class="yui3-datatable-cell pre-row-expansion">&nbsp;</td>';}var q=n.get("template");if(h.Lang.isFunction(q)){var u=q.call(this,k.data);}else{var u=h.Lang.sub(q,k.data);}var t=k.cell.ancestor();var p=h.Lang.sub('<tr class="{c}">'+"{pre}"+'<td colspan="{post}" class="yui3-datatable-cell post-row-expansion">{tmpl}</td>'+"</tr>",{c:t.get("className")+" "+f.row_class,pre:r,post:n.col_count.post,tmpl:u});t.insert(p,"after");}}function c(){function i(j,k){if(k.key==f.column_key){k.nodeFormatter=a;j.found=true;}else{if(k.children){j=h.reduce(k.children,j,i);}else{j[j.found?"post":"pre"]++;}}return j;}this.col_count=h.reduce(this.get("host").get("columns"),{pre:0,post:0,found:false},i);}var b={above:[-1,0],below:[1,0],next:[0,1],prev:[0,-1],previous:[0,-1]};function d(m,j){var l=this.get("container"),s,q;if(m&&l){if(h.Lang.isString(j)){if(b[j]){j=b[j];}else{throw Error("unknown shift in getCell: "+j);}}if(h.Lang.isArray(m)){s=l.get("children").item(0);q=s&&s.get("children").item(m[1]);if(j){j[0]+=m[0];}else{j=[m[0],0];}}else{if(m._node){q=m.ancestor("."+this.getClassName("cell"),true);if(q.ancestor("tr."+f.row_class)){throw Error("getCell cannot be called with an element from an expansion row");}}}if(q&&j){var r=l.get("firstChild.rowIndex");if(h.Lang.isArray(j)){s=q.ancestor();var p=Math.sign(j[0]);if(p!==0){var t=l.get("children");var o=s.get("rowIndex")-r;var n=Math.abs(j[0]);for(var k=0;k<n&&s;k++){o+=p;s=t.item(o);if(s&&s.hasClass(f.row_class)){o+=p;s=t.item(o);}}}o=q.get("cellIndex")+j[1];q=s&&s.get("children").item(o);}}}return(q||null);}function g(j){var i=this.get("container")||null;if(j){j=this._idMap[j.get?j.get("clientId"):j]||j;}return i&&h.one(h.Lang.isNumber(j)?this.getCell([j,0]).ancestor():"#"+j);}function e(){var i=this.get("host").body;if(i instanceof h.DataTable.BodyView){i.getCell=d;i.getRow=g;}}h.extend(f,h.Plugin.Base,{initializer:function(i){this.open_rows={};this.on("uniqueIdKeyChange",function(){this.open_rows={};});c.call(this);this.afterHostEvent("columnsChange",c);this.afterHostEvent("renderTable",e);}});h.namespace("Plugin");h.Plugin.DataTableRowExpansion=f;},"@VERSION@",{requires:["datatable","plugin","gallery-funcprog","gallery-node-optimizations","gallery-math"],skinnable:true});