YUI.add("gallery-quickedit",function(Y){Y.Column.ATTRS.quickEdit={};Y.Column.ATTRS.qeFormatter={validator:Y.Lang.isFunction};function QuickEdit(config){QuickEdit.superclass.constructor.call(this,config);}QuickEdit.NAME="QuickEditPlugin";QuickEdit.NS="qe";QuickEdit.ATTRS={changesAlwaysInclude:{value:[],validator:Y.Lang.isArray}};var class_re_prefix="(?:^|\\s)(?:",class_re_suffix=")(?:\\s|$)",quick_edit_re=/quickedit-key:([^\s]+)/,qe_row_status_prefix="quickedit-has",qe_row_status_pattern=qe_row_status_prefix+"([a-z]+)",qe_row_status_re=new RegExp(class_re_prefix+qe_row_status_pattern+class_re_suffix),qe_cell_status_prefix="quickedit-has",qe_cell_status_pattern=qe_cell_status_prefix+"([a-z]+)",qe_cell_status_re=new RegExp(class_re_prefix+qe_cell_status_pattern+class_re_suffix);QuickEdit.status_order=["error","warn","success","info"];function getStatusPrecedence(status){for(var i=0;i<QuickEdit.status_order.length;i++){if(status==QuickEdit.status_order[i]){return i;}}return QuickEdit.status_order.length;}function statusTakesPrecendence(orig_status,new_status){return(!orig_status||getStatusPrecedence(new_status)<getStatusPrecedence(orig_status));}QuickEdit.error_text_class="quickedit-message-text";QuickEdit.error_display_markup='<div class="quickedit-message-text"></div>';QuickEdit.textFormatter=function(o){var markup='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+QuickEdit.error_display_markup;var qe=o.column.get("quickEdit");return Y.Lang.sub(markup,{key:o.column.get("key"),yiv:qe.validation?(qe.validation.css||""):"",value:o.value||o.value===0?o.value.toString().replace('"',""):""});};QuickEdit.textareaFormatter=function(o){var markup='<textarea class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+QuickEdit.error_display_markup;var qe=o.column.get("quickEdit");return Y.Lang.sub(markup,{key:o.column.get("key"),yiv:qe.validation?(qe.validation.css||""):"",value:o.value||o.value===0?o.value.toString().replace('"',""):""});};QuickEdit.readonlyEmailFormatter=function(o){return(o.value||"");};QuickEdit.readonlyLinkFormatter=function(o){return(o.value||"");};function getSiblingTdEl(el,dir){var tr=null;this._tbodyNode.get("children").some(function(node){if(node.contains(el)){tr=node;return true;}});if(!tr){return null;}var cell=el.getAncestorByTagName("td",true);var col_index=-1;tr.get("children").some(function(node,index){if(node===cell){col_index=index;return true;}});tr=(dir<0?tr.previous():tr.next());return tr?tr.get("children").item(col_index):null;}function copyDown(e,cell){var field=cell.one(".quickedit-field");if(!field){return;}var value=Y.Lang.trim(field.get("value"));if(!value&&value!==0){return;}while(1){cell=getSiblingTdEl.call(this,cell,+1);if(!cell){break;}field=cell.one(".quickedit-field");if(field){field.set("value",value);}}}QuickEdit.copyDownFormatter=function(o){if(o.column.get("quickEdit").copyDown&&o.rowindex===0){var button=Y.Node.create("<button></button>");button.set("title","Copy down");button.set("innerHTML","&darr;");o.td.insert(button,o.td.one("."+QuickEdit.error_text_class));button.on("click",copyDown,o.td,this);}};function wrapFormatter(editFmt,origFmt){return function(o){return(o.record?editFmt:origFmt).apply(this,arguments);};}function moveFocus(e){var cell=getSiblingTdEl.call(this,e.target,e.charCode==38?-1:+1);if(cell){var input=cell.one(".quickedit-field");if(input){input.focus();input.select();e.halt(true);}}}function validateElements(list){var host=this.get("host");var cols=host.get("columnset").keyHash;var status=true;var count=list.size();for(var i=0;i<count;i++){var e=list.item(i);var qe=cols[this._getColumnKey(e)].get("quickEdit");if(!qe){continue;}var msg_list=qe.validation?qe.validation.msg:null;var info=Y.FormManager.validateFromCSSData(e,msg_list);if(info.error){this.displayMessage(e,info.error,"error");status=false;continue;}if(info.keepGoing){if(qe.validation&&qe.validation.regex instanceof RegExp&&!qe.validation.regex.test(e.get("value"))){this.displayMessage(e,msg_list?msg_list.regex:null,"error");status=false;continue;}}if(qe.validation&&Y.Lang.isFunction(qe.validation.fn)&&!qe.validation.fn.call(host,e)){status=false;continue;}}return status;}Y.extend(QuickEdit,Y.Plugin.Base,{initializer:function(config){this.hasMessages=false;},start:function(){this.fire("clearErrorNotification");var host=this.get("host");var cols=host.get("columnset").keys;this.saveSort=[];this.saveEdit={};this.saveFmt={};for(var i=0;i<cols.length;i++){var col=cols[i];var key=col.get("key");this.saveSort.push(col.get("sortable"));col.set("sortable",false);var qe=col.get("quickEdit");var qef=col.get("qeFormatter");if(
/*col.hidden &&*/
(qe||qef)){var fn=null;if(qe&&Y.Lang.isFunction(qe.formatter)){fn=qe.formatter;}else{if(Y.Lang.isFunction(qef)){fn=qef;}else{fn=QuickEdit.textFormatter;}}if(fn){var origFmt=col.get("formatter");var fmt=wrapFormatter.call(this,fn,origFmt);this.saveFmt[key]=origFmt;col.set("formatter",fmt);}}}var container=host.get("contentBox");container.addClass(host.getClassName("quickedit"));this.move_event_handle=container.on("key",moveFocus,"down:38+ctrl,40+ctrl",host);host.syncUI();},cancel:function(){this.fire("clearErrorNotification");var host=this.get("host");var cols=host.get("columnset").keys;for(var i=0;i<cols.length;i++){var col=cols[i];col.set("sortable",this.saveSort[i]);}delete this.saveSort;delete this.saveEdit;cols=host.get("columnset").keyHash;Y.Object.each(this.saveFmt,function(fmt,key){cols[key].set("formatter",fmt);});delete this.saveFmt;var container=host.get("contentBox");container.removeClass(host.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}host.syncUI();},getChanges:function(){if(!this.validate()){return false;}var changes=[];var alwaysInclude=this.get("changesAlwaysInclude");var host=this.get("host");var records=host.get("recordset");var rows=host._tbodyNode.get("children");var row_count=rows.size();var cols=host.get("columnset").keyHash;
for(var i=0;i<row_count;i++){var rec=records.getRecord(i);var list=rows.item(i).all(".quickedit-field");var change={};changes.push(change);var field_count=list.size();for(var j=0;j<field_count;j++){var field=list.item(j);var key=this._getColumnKey(field);var col=cols[key];var qe=col.get("quickEdit");var prev=rec.getValue(key);var val=Y.Lang.trim(field.get("value"));if(qe.changed?qe.changed(prev,val):val!==(prev?prev.toString():"")){change[key]=val;}}for(var j=0;j<alwaysInclude.length;j++){var key=alwaysInclude[j];change[key]=rec.getValue(key);}}return changes;},validate:function(){this.clearMessages();var status=true;var host=this.get("host");var e1=host._tbodyNode.getElementsByTagName("input");var e2=host._tbodyNode.getElementsByTagName("textarea");var e3=host._tbodyNode.getElementsByTagName("select");status=validateElements.call(this,e1)&&status;status=validateElements.call(this,e2)&&status;status=validateElements.call(this,e3)&&status;if(!status){this.fire("notifyErrors");}return status;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var host=this.get("host");host._tbodyNode.getElementsByClassName(qe_row_status_pattern).removeClass(qe_row_status_pattern);host._tbodyNode.getElementsByClassName(qe_cell_status_pattern).removeClass(qe_cell_status_pattern);host._tbodyNode.all("."+QuickEdit.error_text_class).set("innerHTML","");},displayMessage:function(e,msg,type,scroll){if(Y.Lang.isUndefined(scroll)){scroll=true;}e=Y.one(e);var row=e.getAncestorByTagName("tr");if(statusTakesPrecendence(this._getElementStatus(row,qe_row_status_re),type)){if(!this.hasMessages&&scroll){Y.one(row.get("firstChild")).scrollIntoView();}row.replaceClass(qe_row_status_pattern,qe_row_status_prefix+type);this.hasMessages=true;}var cell=e.getAncestorByTagName("td");if(statusTakesPrecendence(this._getElementStatus(cell,qe_cell_status_re),type)){if(msg){cell.one("."+QuickEdit.error_text_class).set("innerHTML",msg);}cell.replaceClass(qe_cell_status_pattern,qe_cell_status_prefix+type);this.hasMessages=true;}},_getElementStatus:function(e,r){var m=e.get("className").match(r);return((m&&m.length)?m[1]:false);},_getColumnKey:function(e){var m=quick_edit_re.exec(e.get("className"));return m[1];}});Y.namespace("Plugin");Y.Plugin.DataTableQuickEdit=QuickEdit;},"@VERSION@",{requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations"],optional:["gallery-scrollintoview"],skinnable:true});